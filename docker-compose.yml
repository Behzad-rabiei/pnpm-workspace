version: '3.9'

networks:
    web: {}

services:
    # ────────────────────────────
    #  1) Reverse‑proxy: Traefik
    # ────────────────────────────
    traefik:
        image: traefik:v3.4
        container_name: traefik

        # ─── STATIC CONFIG ─────────────────────────────────────────────
        command:
            - --providers.docker.exposedByDefault=false
            - --api=true # enable API + dashboard (default dashboard=true)
            - --providers.docker=true
            - --entrypoints.web.address=:80

        # expose only port 80; no raw 8080 any more
        ports:
            - '80:80'

        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro

        # ─── DYNAMIC CONFIG (labels) ───────────────────────────────────
        labels:
            # ---- Dashboard router --------------------------------------
            - traefik.http.routers.traefik.rule=Host(`${PULLPREVIEW_PUBLIC_DNS}`) && (PathPrefix(`/traefik-dashboard`) || PathPrefix(`/api`))
            - traefik.http.routers.traefik.entrypoints=web
            - traefik.http.routers.traefik.service=api@internal
            - traefik.http.routers.traefik.middlewares=traefik-auth

            # ---- Basic‑Auth middleware ---------------------------------
            #   admin / supersecret    (bcrypt hash generated with:
            #   htpasswd -nbB admin supersecret | sed -e 's/\$/$$/g')
            - traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$2y$$05$$Z7tJjCpZ8TEk1fvPt2DkX.0t/w1TnljgAdILW1ei1yKWpj3QSc2wi

        networks: [web]

    # ────────────────────────────
    #  2) Front‑end: UI
    # ────────────────────────────
    ui:
        build:
            context: .
            dockerfile: Dockerfile
            target: ui
        container_name: ui
        restart: unless-stopped
        labels:
            - traefik.enable=true
            - traefik.http.routers.ui.rule=Host(`${PULLPREVIEW_PUBLIC_DNS}`)
            - traefik.http.routers.ui.entrypoints=web
            # Port 8080 is auto‑detected (only port exposed), so we omit
        networks: [web]

    # ────────────────────────────
    #  3) Back‑end: API
    # ────────────────────────────
    api:
        build:
            context: .
            dockerfile: Dockerfile
            target: api
        container_name: api
        restart: unless-stopped
        labels:
            - traefik.enable=true

            ##  Router  -----------------------
            - traefik.http.routers.api.rule=Host(`${PULLPREVIEW_PUBLIC_DNS}`) && PathPrefix(`/api`)
            - traefik.http.routers.api.entrypoints=web
            - traefik.http.routers.api.middlewares=api-strip,api-cors

            ##  Service  ----------------------
            - traefik.http.services.api.loadbalancer.server.port=3000

            ##  Middleware: strip "/api"  ------
            - traefik.http.middlewares.api-strip.stripprefix.prefixes=/api

            ##  Middleware: permissive CORS  ---
            - traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE
            - traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=*

        networks: [web]
