name: Quality Gate üõ°Ô∏è
on:
    workflow_call:
        inputs:
            node-versions:
                required: false
                type: string
                # ‚Üê changed here: include both 20 and 22 by default
                default: '20,22'

jobs:
    code-quality:
        name: 'Code Quality ‚òëÔ∏è (Node.js ${{ matrix.node }})'
        runs-on: ubuntu-22.04
        strategy:
            matrix:
                # this will now expand to [20,22] by default
                node: ${{ fromJSON(format('[{0}]', inputs.node-versions)) }}
        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4
              with:
                  version: 10.12.4
                  run_install: false

            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}
                  cache: pnpm

            - run: pnpm install --frozen-lockfile
            - run: pnpm run check

    test:
        name: 'Test üß™ (Node.js ${{ matrix.node }})'
        needs: code-quality
        runs-on: ubuntu-22.04
        strategy:
            matrix:
                node: ${{ matrix.node }}
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10.12.4
                  run_install: false
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm run ci:test
              env:
                  CI: 'true'
            - uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}

    build:
        name: 'Build üèóÔ∏è (Node.js ${{ matrix.node }})'
        needs: [code-quality, test]
        runs-on: ubuntu-22.04
        strategy:
            matrix:
                node: ${{ matrix.node }}
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: 10.12.4
                  run_install: false
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node }}
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm run build
