# reusable-docker.yml
name: Docker / Build & Push Image

on:
    workflow_call:
        inputs:
            target: { required: true, type: string }
            image-name: { required: true, type: string }
            context: { required: false, type: string, default: '.' }
            dockerfile: { required: false, type: string, default: 'Dockerfile' }
            image-tags: { required: true, type: string } # newline-separated list
        secrets:
            GHCR_TOKEN: { required: true }

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: docker/setup-buildx-action@v2

            - uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build & push
              uses: docker/build-push-action@v4
              with:
                  context: ${{ inputs.context }}
                  file: ${{ inputs.dockerfile }}
                  target: ${{ inputs.target }}
                  push: true
                  tags: ${{ inputs.image-tags }}
                  cache-from: type=registry,ref=${{ inputs.image-name }}:cache
                  cache-to: type=registry,ref=${{ inputs.image-name }}:cache,mode=max
