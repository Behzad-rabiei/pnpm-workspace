# .github/workflows/reusable-docker.yml
name: Docker / Build & Push Image

on:
    workflow_call:
        inputs:
            target: { required: true, type: string } 
            image-name: { required: true, type: string } 
            context: { required: false, type: string, default: '.' }
            dockerfile: { required: false, type: string, default: 'Dockerfile' }
        secrets:
            GHCR_TOKEN: { required: true }

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4
            - name: Prepare lowercase vars
              id: lc
              shell: bash
              run: |
                  echo "OWNER_LC=${{ github.repository_owner,, }}"     >>"$GITHUB_ENV"
                  echo "ACTOR_LC=${{ github.actor,, }}"                >>"$GITHUB_ENV"
                  echo "IMAGE_NAME_LC=$(echo '${{ inputs.image-name }}' | tr '[:upper:]' '[:lower:]')" >>"$GITHUB_ENV"

            - uses: docker/setup-buildx-action@v2

            - uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ env.ACTOR_LC }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Build & (optionally) push
              uses: docker/build-push-action@v4
              with:
                  context: ${{ inputs.context }}
                  file: ${{ inputs.dockerfile }}
                  target: ${{ inputs.target }}
                  push: ${{ github.event_name == 'push' }} 
                  tags: |
                      ${{ env.IMAGE_NAME_LC }}:latest
                      ${{ env.IMAGE_NAME_LC }}:${{ github.sha }}
                  cache-from: type=registry,ref=${{ env.IMAGE_NAME_LC }}:cache
                  cache-to: type=registry,ref=${{ env.IMAGE_NAME_LC }}:cache,mode=max
