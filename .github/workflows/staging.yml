name: Staging üê≥
on:
    push:
        branches: [main]

env:
    TAG_MAIN: main-${{ github.sha }}

jobs:
    gate: { uses: ./.github/workflows/_quality-gate.yml }

    build:
        needs: gate
        uses: ./.github/workflows/_build-and-push.yml
        with:
            ref: ${{ github.sha }}
            tag: ${{ env.TAG_MAIN }}
            push: true
            latest: false

    retag-staging:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Retag :staging alias and push
              run: |
                  for img in api ui workflows; do
                    docker pull ghcr.io/behzad-rabiei/pnpm-workspace/$img:${TAG_MAIN}
                    docker tag ghcr.io/behzad-rabiei/pnpm-workspace/$img:${TAG_MAIN} \
                              ghcr.io/behzad-rabiei/pnpm-workspace/$img:staging
                    docker push ghcr.io/behzad-rabiei/pnpm-workspace/$img:staging
                  done
            - name: Trigger remote staging stack update (Watchtower will notice)
              run: echo "Nothing to do ‚Äì Watchtower pulls :staging automatically."
