# .github/workflows/pullâ€‘requestâ€‘andâ€‘preview.yml
name: PR CI & Preview ðŸš€

on:
    pull_request:
        branches: [main]
        # We still listen to label / close events so the preview can be (re)deployed
        # or destroyed, but the codeâ€‘related jobs will selfâ€‘skip on those events.
        types: [opened, synchronize, reopened, labeled, unlabeled, closed]

concurrency:
    group: ci-${{ github.event.pull_request.number }}
    cancel-in-progress: true

################################################################################
# 1) Qualityâ€‘gate (runs only on real code changes)                              #
################################################################################
jobs:
    quality-gate:
        if: ${{ contains(fromJson('["opened","synchronize","reopened"]'), github.event.action) }}
        uses: ./.github/workflows/_quality-gate.yml

    ################################################################################
    # 2) Build (depends on qualityâ€‘gate, same guard)                                #
    ################################################################################
    build:
        needs: quality-gate
        # Build runs only when qualityâ€‘gate actually ran and succeeded.
        if: ${{ needs.quality-gate.result == 'success' }}
        uses: ./.github/workflows/_build-and-push.yml
        with:
            ref: ${{ github.sha }}
            push: false

    ################################################################################
    # 3) Pullâ€‘preview (needs build)                                                 #
    ################################################################################
    pull-preview:
        name: Pull Preview ðŸ‘€
        needs: build # <-- guarantees a successful build first
        runs-on: ubuntu-latest
        # Only deploy when the PR has (or just received) the `pullpreview` label.
        if: >
            ${{
              (needs.build.result == 'success' || needs.build.result == 'skipped') &&
              github.event_name == 'pull_request' &&
              (github.event.label.name == 'pullpreview' ||
              contains(github.event.pull_request.labels.*.name, 'pullpreview'))
            }}
        timeout-minutes: 30
        permissions:
            contents: read
            deployments: write
            pull-requests: write
            statuses: write
        steps:
            - uses: actions/checkout@v4

            - uses: pullpreview/action@v5
              with:
                  always_on: main
                  label: pullpreview
                  provider: lightsail
                  instance_type: micro
                  compose_files: docker/docker-compose.preview.yml
                  ttl: 24h
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  AWS_REGION: us-east-1
