name: Promote to Production ðŸš€
on:
    workflow_dispatch:
        inputs:
            digest:
                description: 'Exact digest or "staging" to promote'
                required: true
                type: string

env:
    IMAGES: api ui workflows

jobs:
    promote:
        runs-on: ubuntu-latest
        environment: production
        steps:
            - uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Retag :prod alias
              run: |
                  for img in $IMAGES; do
                    docker pull ghcr.io/behzad-rabiei/pnpm-workspace/$img:${{ github.event.inputs.digest }}
                    docker tag  ghcr.io/behzad-rabiei/pnpm-workspace/$img:${{ github.event.inputs.digest }} \
                                ghcr.io/behzad-rabiei/pnpm-workspace/$img:prod
                    docker push ghcr.io/behzad-rabiei/pnpm-workspace/$img:prod
                  done
            - name: Done â€“ Watchtower (prod) will deploy automatically
              run: echo "Promoted!"
