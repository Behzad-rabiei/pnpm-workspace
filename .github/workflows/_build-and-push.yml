# .github/workflows/_build-and-push.yaml
name: Build & Push Docker Images üê≥

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref (branch, tag, or SHA) to build'
        required: true
        type: string
      tag-suffix:
        description: 'Suffix for the image tag (e.g. pr-48)'
        required: true
        type: string
      push:
        description: 'Whether to push the image'
        required: true
        type: boolean
      latest:
        description: 'Also tag as :latest'
        required: false
        type: boolean
        default: false
      image:
        description: 'Which Docker target to build (api, ui, workflows)'
        required: true
        type: string
        default: 'api'

env:
  REGISTRY: ghcr.io
  # lowercase the entire "owner/repo" slug so Docker is happy
  REPO: ${{ toLower(github.repository) }}

jobs:
  docker-image:
    name: Build & Push üê≥ (target: ${{ inputs.image }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2

      - name: Restore Buildx cache
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ env.REPO }}-${{ inputs.image }}-${{ inputs.tag-suffix }}
          restore-keys: |
            buildx-${{ env.REPO }}-${{ inputs.image }}-
            buildx-${{ env.REPO }}-

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build (and maybe push) ${{ inputs.image }}
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          target: ${{ inputs.image }}
          push: ${{ inputs.push }}
          # always emit the primary tag, then ONLY if `latest` is true, add the extra line
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}/${{ inputs.image }}:${{ inputs.tag-suffix }}${{ inputs.latest && '\n' || '' }}${{ inputs.latest && format('{0}/{1}/{2}:latest', env.REGISTRY, env.REPO, inputs.image) || '' }}
