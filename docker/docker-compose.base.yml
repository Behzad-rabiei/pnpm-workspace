version: '3.9'

x-common-labels: &common_labels
    traefik.enable: 'true'

networks:
    web:

services:
    traefik:
        image: traefik:v3.4
        container_name: traefik
        restart: unless-stopped
        ports: # expose both 80 & 443
            - '80:80'
            - '443:443'
        env_file: .env # keeps CF_API_TOKEN, CF_API_EMAIL, ACME_EMAIL
        environment:
            - CF_API_TOKEN=${CF_API_TOKEN}
            - TRAEFIK_CERTIFICATESRESOLVERS_cf_acme_email=${ACME_EMAIL}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
            - ./traefik/acme.json:/etc/traefik/acme.json
        networks: [web]
        command:
            # minimal CLI â€“ everything else lives in traefik.yml
            - '--providers.docker'
            - '--entrypoints.websecure.http.tls.certresolver=cf'

    ui: # static assets / SPA
        image: ghcr.io/behzad-rabiei/pnpm-workspace/ui:${IMAGE_TAG}
        restart: unless-stopped
        networks: [web]
        labels:
            <<: *common_labels
            traefik.http.routers.ui.rule: >
                Host(`${UI_DOMAIN}`)      # injected from env file
            traefik.http.routers.ui.entrypoints: websecure
            traefik.http.services.ui.loadbalancer.server.port: '3000'

    api: # Node / Express / etc.
        image: ghcr.io/behzad-rabiei/pnpm-workspace/api:${IMAGE_TAG}
        restart: unless-stopped
        networks: [web]
        labels:
            <<: *common_labels
            traefik.http.routers.api.rule: >
                Host(`${API_DOMAIN}`) && PathPrefix(`/api`)
            traefik.http.routers.api.entrypoints: websecure
            traefik.http.routers.api.middlewares: api-strip,api-cors
            traefik.http.services.api.loadbalancer.server.port: '3000'
            traefik.http.middlewares.api-strip.stripprefix.prefixes: '/api'
            traefik.http.middlewares.api-cors.headers.accessControlAllowMethods: 'GET,OPTIONS,PUT,POST,DELETE'
            traefik.http.middlewares.api-cors.headers.accessControlAllowOriginList: '*'

    watchtower:
        image: containrrr/watchtower:latest
        restart: unless-stopped
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        networks: [web]
